name: Deploy Demo

on:
  push:
    branches: [main]
    paths:
      - 'container/**'
      - 'api/**'
      - 'frontend/**'
      - 'docker-compose.yml'
      - '.github/workflows/deploy-demo.yml'
  workflow_dispatch:

env:
  DOCKER_IMAGE: autonops/infraiq-demo
  GCE_INSTANCE: demo-server
  GCE_ZONE: us-central1-a

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push demo image
        uses: docker/build-push-action@v5
        with:
          context: ./container
          file: ./container/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to GCE
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to VM
        run: |
          gcloud compute ssh ${{ env.GCE_INSTANCE }} \
            --zone ${{ env.GCE_ZONE }} \
            --command "cd /opt/infraiq-demo && \
              docker pull ${{ env.DOCKER_IMAGE }}:latest && \
              docker compose down && \
              docker compose up -d && \
              echo 'Deployment complete!'"

      - name: Health check
        run: |
          sleep 10
          curl -f https://demo.autonops.io/api/health || exit 1
          echo "Health check passed!"
